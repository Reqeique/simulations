<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acetic Acid/Sodium Acetate Buffer Simulation (shadcn/ui style)</title>
    <!-- Using Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Basic shadcn/ui-inspired CSS Variables (Light Mode Defaults) */
        :root {
            --background: 0 0% 100%; /* white */
            --foreground: 240 10% 3.9%; /* near black */
            --card: 0 0% 100%;
            --card-foreground: 240 10% 3.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 240 10% 3.9%;
            --primary: 240 5.9% 10%;
            --primary-foreground: 0 0% 98%;
            --secondary: 240 4.8% 95.9%;
            --secondary-foreground: 240 5.9% 10%;
            --muted: 240 4.8% 95.9%;
            --muted-foreground: 240 3.8% 46.1%;
            --accent: 240 4.8% 95.9%;
            --accent-foreground: 240 5.9% 10%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 0 0% 98%;
            --border: 240 5.9% 90%;
            --input: 240 5.9% 90%;
            --ring: 240 5.9% 10%;
            --radius: 0.5rem;
        }

        /* Dark Mode Variables */
        .dark {
            --background: 240 10% 3.9%; /* near black */
            --foreground: 0 0% 98%; /* near white */
            --card: 240 10% 3.9%;
            --card-foreground: 0 0% 98%;
            --popover: 240 10% 3.9%;
            --popover-foreground: 0 0% 98%;
            --primary: 0 0% 98%;
            --primary-foreground: 240 5.9% 10%;
            --secondary: 240 3.7% 15.9%;
            --secondary-foreground: 0 0% 98%;
            --muted: 240 3.7% 15.9%;
            --muted-foreground: 240 5% 64.9%;
            --accent: 240 3.7% 15.9%;
            --accent-foreground: 0 0% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 0 0% 98%;
            --border: 240 3.7% 15.9%;
            --input: 240 3.7% 15.9%;
            --ring: 0 0% 98%;
        }

        /* Apply base styles */
        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: background-color 0.2s, color 0.2s;
        }

        /* Component Styles (Simulating shadcn/ui with Tailwind) */
        .card {
            background-color: hsl(var(--card));
            color: hsl(var(--card-foreground));
            border-radius: var(--radius);
            border: 1px solid hsl(var(--border));
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); /* Basic shadow */
        }
        .dark .card {
             box-shadow: 0 1px 3px 0 rgba(0,0,0,0.3), 0 1px 2px 0 rgba(0,0,0,0.2); /* Darker shadow */
        }

        .card-header { padding: 1.5rem; padding-bottom: 0; }
        .card-title { font-size: 1.25rem; font-weight: 600; line-height: 1.1; letter-spacing: -0.025em; }
        .card-description { color: hsl(var(--muted-foreground)); font-size: 0.875rem; }
        .card-content { padding: 1.5rem; }
        .card-footer { padding: 1.5rem; padding-top: 0; }

        .label { font-size: 0.875rem; font-weight: 500; line-height: 1; margin-bottom: 0.5rem; display: block;}

        .slider-track {
            position: relative;
            width: 100%;
            height: 0.5rem; /* 8px */
            background-color: hsl(var(--secondary));
            border-radius: 9999px; /* rounded-full */
            cursor: pointer;
            overflow: hidden;
        }
        .slider-range {
            position: absolute;
            height: 100%;
            background-color: hsl(var(--primary));
        }
        .slider-thumb {
            display: block;
            position: absolute;
            width: 1rem; /* 16px */
            height: 1rem; /* 16px */
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: hsl(var(--primary));
            border: 2px solid hsl(var(--primary-foreground)); /* Adjust if needed */
            border-radius: 9999px;
            cursor: pointer;
            pointer-events: none; /* Thumb doesn't block clicks on track */
        }
        /* Hidden actual range input */
        .slider-input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            top: 0;
            left: 0;
            margin: 0;
            padding: 0;
        }


        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            padding: 0.5rem 1rem; /* Adjust as needed */
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border: 1px solid transparent;
        }
        .button:hover {
             background-color: hsl(var(--primary) / 0.9); /* Slight opacity change */
        }
        .button-secondary {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            border-color: hsl(var(--border));
        }
        .button-secondary:hover {
            background-color: hsl(var(--secondary) / 0.8);
        }


        .progress-root {
            position: relative;
            height: 1rem; /* h-4 */
            width: 100%;
            overflow: hidden;
            border-radius: var(--radius);
            background-color: hsl(var(--secondary));
        }
        .progress-indicator {
            height: 100%;
            width: 0%; /* Controlled by JS */
            background-color: hsl(var(--primary));
            transition: width 0.3s ease-out;
        }

        /* Specific adjustment for visualization legend colors */
        .legend-dot { width: 0.75rem; height: 0.75rem; border-radius: 9999px; display: inline-block; margin-right: 0.5rem; flex-shrink: 0;}
    </style>
    <script>
        // Simple Tailwind config object (not used by CDN but good for reference)
        const tailwindConfig = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: 'hsl(var(--border))',
                        input: 'hsl(var(--input))',
                        ring: 'hsl(var(--ring))',
                        background: 'hsl(var(--background))',
                        foreground: 'hsl(var(--foreground))',
                        primary: {
                            DEFAULT: 'hsl(var(--primary))',
                            foreground: 'hsl(var(--primary-foreground))',
                        },
                        secondary: {
                            DEFAULT: 'hsl(var(--secondary))',
                            foreground: 'hsl(var(--secondary-foreground))',
                        },
                        destructive: {
                            DEFAULT: 'hsl(var(--destructive))',
                            foreground: 'hsl(var(--destructive-foreground))',
                        },
                        muted: {
                            DEFAULT: 'hsl(var(--muted))',
                            foreground: 'hsl(var(--muted-foreground))',
                        },
                        accent: {
                            DEFAULT: 'hsl(var(--accent))',
                            foreground: 'hsl(var(--accent-foreground))',
                        },
                        popover: {
                            DEFAULT: 'hsl(var(--popover))',
                            foreground: 'hsl(var(--popover-foreground))',
                        },
                        card: {
                            DEFAULT: 'hsl(var(--card))',
                            foreground: 'hsl(var(--card-foreground))',
                        },
                    },
                    borderRadius: {
                        lg: `var(--radius)`,
                        md: `calc(var(--radius) - 2px)`,
                        sm: 'calc(var(--radius) - 4px)',
                    },
                }
            }
        }
    </script>
</head>
<body class="transition-colors duration-200">
    <div class="container mx-auto px-4 py-8 max-w-6xl"> <!-- Increased max-width slightly -->
        <h1 class="text-3xl font-bold text-center mb-2 tracking-tight">Acetic Acid/Sodium Acetate Buffer</h1>
        <p class="text-center text-muted-foreground mb-8">Simulating buffer action against HCl addition</p>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Controls Panel -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Buffer Setup</h2>
                </div>
                <div class="card-content space-y-6">
                    <!-- Acetic Acid Concentration -->
                    <div>
                        <label class="label" for="acetic-concentration">
                            Acetic Acid (M): <span id="acetic-value" class="font-semibold text-primary">0.100</span>
                        </label>
                        <!-- Custom Slider -->
                        <div class="slider-track">
                            <div id="acetic-range" class="slider-range"></div>
                            <div id="acetic-thumb" class="slider-thumb"></div>
                            <input type="range" id="acetic-concentration" min="0.01" max="0.5" step="0.01" value="0.1" class="slider-input">
                        </div>
                    </div>

                    <!-- Sodium Acetate Concentration -->
                    <div>
                        <label class="label" for="acetate-concentration">
                            Sodium Acetate (M): <span id="acetate-value" class="font-semibold text-primary">0.100</span>
                        </label>
                         <div class="slider-track">
                            <div id="acetate-range" class="slider-range"></div>
                            <div id="acetate-thumb" class="slider-thumb"></div>
                            <input type="range" id="acetate-concentration" min="0.01" max="0.5" step="0.01" value="0.1" class="slider-input">
                        </div>
                    </div>

                    <!-- HCl Addition -->
                    <div>
                        <label class="label" for="hcl-concentration">
                            HCl Added (M): <span id="hcl-value" class="font-semibold text-destructive">0.000</span>
                        </label>
                         <div class="slider-track">
                            <div id="hcl-range" class="slider-range" style="background-color: hsl(var(--destructive));"></div>
                             <div id="hcl-thumb" class="slider-thumb" style="background-color: hsl(var(--destructive)); border-color: hsl(var(--destructive-foreground));"></div>
                            <input type="range" id="hcl-concentration" min="0" max="0.2" step="0.001" value="0" class="slider-input">
                        </div>
                    </div>

                    <!-- Ka Value -->
                    <div class="text-sm pt-2">
                        <span class="font-medium">Ka (Acetic Acid):</span>
                        <span id="ka-value" class="ml-2 font-mono text-muted-foreground">1.8 × 10⁻⁵</span>
                        <span class="ml-2 font-medium text-muted-foreground">(pKa = 4.74)</span>
                    </div>

                    <div>
                        <button id="reset-btn" class="button w-full mt-2">
                            Reset Simulation
                        </button>
                    </div>
                </div>
            </div>

            <!-- pH and Buffer Capacity Panel -->
            <div class="card">
                 <div class="card-header">
                    <h2 class="card-title">System State</h2>
                </div>
                <div class="card-content space-y-4">
                     <!-- pH Values -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="border rounded-md p-3 text-center bg-secondary">
                            <h3 class="text-xs font-medium text-muted-foreground uppercase tracking-wider">Initial pH</h3>
                            <p id="initial-ph" class="text-2xl font-bold">4.74</p>
                        </div>
                        <div class="border rounded-md p-3 text-center bg-secondary">
                            <h3 class="text-xs font-medium text-muted-foreground uppercase tracking-wider">Current pH</h3>
                            <p id="current-ph" class="text-2xl font-bold">4.74</p>
                        </div>
                    </div>

                     <!-- pH Change Info -->
                    <div class="border rounded-md p-3 text-center bg-secondary">
                        <h3 class="text-xs font-medium text-muted-foreground uppercase tracking-wider">pH Change vs Initial</h3>
                        <p id="ph-change" class="text-xl font-bold">0.00</p>
                    </div>

                    <!-- Buffer Capacity Gauge -->
                    <div>
                        <h3 class="label mb-1 text-muted-foreground">Buffer Capacity</h3>
                        <div class="progress-root">
                             <div id="buffer-capacity-bar" class="progress-indicator bg-gradient-to-r from-red-500 via-yellow-500 to-green-500"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1 text-muted-foreground">
                            <span>Low</span>
                            <span>High</span>
                        </div>
                    </div>

                    <!-- Henderson-Hasselbalch Equation -->
                    <div class="p-3 border rounded-md bg-muted/50">
                        <h3 class="text-sm font-medium mb-2 text-center">Henderson-Hasselbalch:</h3>
                        <p class="font-mono text-center text-sm">pH = pKa + log([A⁻]/[HA])</p>
                        <p id="hh-equation-values" class="font-mono text-center text-sm mt-2 text-muted-foreground">4.74 = 4.74 + log(0.100/0.100)</p>
                    </div>
                </div>
            </div>

            <!-- Visualization & Charts -->
             <div class="card">
                 <div class="card-header">
                    <h2 class="card-title">Concentrations & pH Curve</h2>
                </div>
                <div class="card-content space-y-6">
                    <!-- Concentration Chart -->
                    <div>
                         <h3 class="label mb-1 text-muted-foreground">Species Concentrations</h3>
                        <div class="w-full h-56">
                            <canvas id="concentration-chart"></canvas>
                        </div>
                    </div>

                    <!-- pH vs HCl Chart -->
                     <div>
                        <h3 class="label mt-4 mb-1 text-muted-foreground">Buffer Action: pH vs HCl Added</h3>
                        <div class="w-full h-48">
                            <canvas id="ph-curve-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Molecular Visualization -->
        <div class="mt-6 card">
             <div class="card-header">
                 <h2 class="card-title">Molecular View (Conceptual)</h2>
             </div>
             <div class="card-content">
                <div id="visualization" class="border rounded-md h-64 relative overflow-hidden bg-muted">
                    <!-- Particles will be added here by JS -->
                </div>

                <div class="mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2 text-sm text-muted-foreground">
                    <div class="flex items-center">
                        <span class="legend-dot bg-yellow-500"></span>
                        <span>CH₃COOH</span>
                    </div>
                    <div class="flex items-center">
                        <span class="legend-dot bg-green-500"></span>
                        <span>CH₃COO⁻</span>
                    </div>
                    <div class="flex items-center">
                        <span class="legend-dot bg-purple-500"></span>
                        <span>Na⁺</span>
                    </div>
                    <div class="flex items-center">
                         <span class="legend-dot bg-red-500"></span>
                        <span>H⁺ (from HCl/Equil.)</span>
                    </div>
                    <div class="flex items-center">
                        <span class="legend-dot bg-blue-500"></span>
                        <span>Cl⁻</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Explanation -->
        <div class="mt-6 card">
             <div class="card-header">
                 <h2 class="card-title">Understanding Buffer Action</h2>
             </div>
             <div class="card-content">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-semibold mb-2">How This Buffer Works</h3>
                        <div class="space-y-3 text-sm text-muted-foreground">
                             <p>
                                A buffer resists pH changes upon addition of small amounts of acid or base. This acetic acid (CH₃COOH) / sodium acetate (provides CH₃COO⁻) buffer relies on the equilibrium:
                            </p>
                            <p class="text-center my-3 font-mono p-2 bg-muted rounded-md border text-card-foreground">
                                CH₃COOH(aq) ⇌ CH₃COO⁻(aq) + H⁺(aq)
                            </p>
                             <p>
                                Added strong acid (HCl) dissociates completely:
                            </p>
                            <p class="text-center my-3 font-mono p-2 bg-muted rounded-md border text-card-foreground">
                                HCl(aq) → H⁺(aq) + Cl⁻(aq)
                            </p>
                            <p>
                                The added H⁺ ions are consumed by the acetate ions (CH₃COO⁻, the conjugate base) shifting the equilibrium left, thus minimizing the increase in free [H⁺] and stabilizing the pH:
                             </p>
                              <p class="text-center my-3 font-mono p-2 bg-muted rounded-md border text-card-foreground">
                                H⁺(added) + CH₃COO⁻(aq) → CH₃COOH(aq)
                            </p>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">Buffer Capacity Factors</h3>
                        <ul class="list-disc list-inside space-y-2 text-sm text-muted-foreground">
                            <li>Capacity is highest when [CH₃COOH] ≈ [CH₃COO⁻] (ratio near 1:1), meaning pH ≈ pKa.</li>
                            <li>Higher total concentrations of both buffer components ([HA] + [A⁻]) lead to greater capacity.</li>
                            <li>Most effective buffering occurs within pH = pKa ± 1 (here, approx. 3.74 - 5.74).</li>
                            <li>Adding excessive acid (or base) will eventually overwhelm the buffer, causing rapid pH change.</li>
                            <li>The Henderson-Hasselbalch equation relates pH, pKa, and the ratio of the conjugate base [A⁻] to the weak acid [HA].</li>
                        </ul>
                    </div>
                </div>
             </div>
        </div>
    </div>

    <script>
        // Dark mode toggle based on system preference
        function applyDarkModePreference() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        applyDarkModePreference(); // Apply on initial load

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyDarkModePreference);

        // --- Simulation Logic (mostly unchanged, but DOM references updated) ---

        // DOM elements
        const aceticConcentration = document.getElementById('acetic-concentration');
        const aceticValue = document.getElementById('acetic-value');
        const aceticRange = document.getElementById('acetic-range');
        const aceticThumb = document.getElementById('acetic-thumb');

        const acetateConcentration = document.getElementById('acetate-concentration');
        const acetateValue = document.getElementById('acetate-value');
        const acetateRange = document.getElementById('acetate-range');
        const acetateThumb = document.getElementById('acetate-thumb');

        const hclConcentration = document.getElementById('hcl-concentration');
        const hclValue = document.getElementById('hcl-value');
        const hclRange = document.getElementById('hcl-range');
        const hclThumb = document.getElementById('hcl-thumb');

        const kaValue = document.getElementById('ka-value');
        const initialPh = document.getElementById('initial-ph');
        const currentPh = document.getElementById('current-ph');
        const phChange = document.getElementById('ph-change');
        const hhEquationValues = document.getElementById('hh-equation-values');
        const bufferCapacityProgress = document.getElementById('buffer-capacity-bar'); // Updated ID
        const resetBtn = document.getElementById('reset-btn');
        const visualization = document.getElementById('visualization');

        // Charts
        let concentrationChart = null;
        let phCurveChart = null;

        // Constants
        const KA_ACETIC = 1.8e-5;
        const PKA_ACETIC = -Math.log10(KA_ACETIC);

        // State variables
        let aceticConc = parseFloat(aceticConcentration.value);
        let acetateConc = parseFloat(acetateConcentration.value);
        let hclConc = parseFloat(hclConcentration.value);
        let initialPHValue = 0;
        let particles = [];
        let animationFrame; // For particle animation

        // --- Utility function to get CSS variable ---
        function getCssVariable(variable) {
            return getComputedStyle(document.documentElement).getPropertyValue(variable).trim();
        }

        // --- Slider UI Update ---
        function updateSliderVisual(sliderElement, rangeElement, thumbElement) {
            const min = parseFloat(sliderElement.min);
            const max = parseFloat(sliderElement.max);
            const value = parseFloat(sliderElement.value);
            const percentage = ((value - min) / (max - min)) * 100;
            rangeElement.style.width = `${percentage}%`;
            thumbElement.style.left = `calc(${percentage}% - ${percentage / 100 * 16}px)`; // Adjust thumb based on its size (16px)
        }


        // Initialize Charts
        function initCharts() {
             // Destroy existing charts if they exist
            if (concentrationChart) concentrationChart.destroy();
            if (phCurveChart) phCurveChart.destroy();

            const isDarkMode = document.documentElement.classList.contains('dark');
            // Use CSS variables for colors
            const textColor = `hsl(${getCssVariable('--foreground')})`;
            const gridColor = `hsl(${getCssVariable('--border')})`;
            const primaryColor = `hsl(${getCssVariable('--primary')})`;
            const destructiveColor = `hsl(${getCssVariable('--destructive')})`;
            const secondaryColor = `hsl(${getCssVariable('--secondary')})`; // For less prominent elements

            // Concentration chart
            const concentrationCanvas = document.getElementById('concentration-chart');
            if (!concentrationCanvas) return;
            const concentrationCtx = concentrationCanvas.getContext('2d');
            if (!concentrationCtx) return;
            concentrationChart = new Chart(concentrationCtx, {
                type: 'bar',
                data: {
                    labels: ['CH₃COOH', 'CH₃COO⁻', 'Na⁺', 'H⁺', 'Cl⁻'],
                    datasets: [{
                        label: 'Concentration (M)',
                        data: [0, 0, 0, 0, 0],
                        // Using fixed colors for chemical species consistency
                        backgroundColor: [
                            'rgba(245, 158, 11, 0.7)', // yellow-500
                            'rgba(16, 185, 129, 0.7)', // green-500
                            'rgba(168, 85, 247, 0.7)', // purple-500
                            'rgba(239, 68, 68, 0.7)',  // red-500
                            'rgba(59, 130, 246, 0.7)', // blue-500
                        ],
                         borderColor: [ // Slightly darker borders
                            'rgba(245, 158, 11, 1)',
                            'rgba(16, 185, 129, 1)',
                            'rgba(168, 85, 247, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(59, 130, 246, 1)',
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Concentration (M)', color: textColor },
                            ticks: { color: textColor, callback: function(value) { return value < 0.001 ? value.toExponential(1) : value.toFixed(3); } },
                            grid: { color: gridColor }
                        },
                        x: { ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                }
            });

            // pH Curve chart
            const phCurveCanvas = document.getElementById('ph-curve-chart');
            if (!phCurveCanvas) return;
            const phCurveCtx = phCurveCanvas.getContext('2d');
            if (!phCurveCtx) return;
            phCurveChart = new Chart(phCurveCtx, {
                type: 'line',
                data: { labels: [], datasets: [
                    {
                        label: 'Buffer Solution', data: [],
                        borderColor: primaryColor,
                        backgroundColor: primaryColor + '1A', // Add alpha
                        tension: 0.1, fill: true
                    },
                    {
                        label: 'Water (No Buffer)', data: [],
                        borderColor: destructiveColor,
                        backgroundColor: destructiveColor + '1A', // Add alpha
                        borderDash: [5, 5],
                        tension: 0.1, fill: false
                    }
                ]},
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { color: textColor } } },
                    scales: {
                        y: {
                            title: { display: true, text: 'pH', color: textColor },
                            ticks: { color: textColor }, grid: { color: gridColor }
                        },
                        x: {
                            title: { display: true, text: 'HCl Added (M)', color: textColor },
                            ticks: { color: textColor }, grid: { color: gridColor }
                        }
                    }
                }
            });
        }

        // Calculate equilibrium concentrations and pH (logic unchanged)
        function calculateEquilibrium() {
            const initialAcetic = aceticConc;
            const initialAcetate = acetateConc;
            const initialHCl = hclConc;

            const acetateConsumed = Math.min(initialAcetate, initialHCl);
            const hclRemaining = initialHCl - acetateConsumed;

            const finalAcetate = initialAcetate - acetateConsumed;
            const finalAcetic = initialAcetic + acetateConsumed;
            const finalNa = initialAcetate; // Na+ concentration unchanged (from NaAcetate)
            const finalCl = initialHCl;     // All added Cl- remains

            let hConcFromEquilibrium;
            if (finalAcetate > 1e-9) { // Avoid division by zero or near-zero
                hConcFromEquilibrium = KA_ACETIC * (finalAcetic / finalAcetate);
            } else {
                 // If buffer base depleted, H+ is primarily from excess strong acid and some weak acid dissociation
                 // Approximate: H+ comes mainly from remaining HCl, plus some from HA dissociation
                let approxHFromHA = (finalAcetic > 1e-9) ? Math.sqrt(KA_ACETIC * finalAcetic) : 0;
                 hConcFromEquilibrium = approxHFromHA; // H+ from weak acid dissociation
            }
             // Total H+ is sum from remaining strong acid and the equilibrium concentration
            const totalHConc = hclRemaining + hConcFromEquilibrium;

            const pH = totalHConc > 1e-14 ? -Math.log10(totalHConc) : 14; // Handle very low H+

            const waterHConc = initialHCl > 1e-9 ? initialHCl : 1e-7;
            const waterPH = -Math.log10(waterHConc);

             // Buffer capacity score (simplified: favors 1:1 ratio and higher total conc)
            const ratio = (finalAcetic > 1e-9 && finalAcetate > 1e-9) ? finalAcetate / finalAcetic : 0;
            const idealRatioFactor = Math.exp(-0.5 * Math.pow(Math.log(ratio || 1e-9), 2)); // Gaussian peak at ratio=1
            const totalBufferConcentration = finalAcetic + finalAcetate;
            // Normalize concentration effect (max effect around 0.5M total)
            const concentrationFactor = 1 - Math.exp(-5 * totalBufferConcentration);
            const bufferCapacityScore = idealRatioFactor * concentrationFactor;


            return {
                aceticConc: finalAcetic, acetateConc: finalAcetate, naConc: finalNa,
                hConc: totalHConc, clConc: finalCl, pH: pH,
                waterPH: waterPH, bufferCapacityScore: Math.max(0, Math.min(1, bufferCapacityScore)), // Clamp between 0 and 1
                ratio: ratio
            };
        }

        // Calculate and update pH curve data (logic unchanged)
         function updatePHCurveData() {
            const currentAcetic = aceticConc;
            const currentAcetate = acetateConc;
            const hclPoints = [];
            const bufferPHPoints = [];
            const waterPHPoints = [];
            const numPoints = 41; // Increased points for smoother curve
            const maxHCl = 0.2;

            for (let i = 0; i < numPoints; i++) {
                const pointHCl = (i / (numPoints - 1)) * maxHCl;
                hclPoints.push(pointHCl.toFixed(3));
                // Use temporary state for calculation
                const tempResult = calculateEquilibriumAt(currentAcetic, currentAcetate, pointHCl);
                bufferPHPoints.push(tempResult.pH);
                waterPHPoints.push(tempResult.waterPH);
            }
            return { labels: hclPoints, bufferPHPoints: bufferPHPoints, waterPHPoints: waterPHPoints };
        }

        // Helper function for curve calculation without modifying global state
        function calculateEquilibriumAt(initialAcetic, initialAcetate, hclAdded) {
             // Simplified clone of calculateEquilibrium logic for curve points
            const acetateConsumed = Math.min(initialAcetate, hclAdded);
            const hclRemaining = hclAdded - acetateConsumed;
            const finalAcetate = initialAcetate - acetateConsumed;
            const finalAcetic = initialAcetic + acetateConsumed;

            let hConcFromEquilibrium;
            if (finalAcetate > 1e-9) {
                hConcFromEquilibrium = KA_ACETIC * (finalAcetic / finalAcetate);
            } else {
                 let approxHFromHA = (finalAcetic > 1e-9) ? Math.sqrt(KA_ACETIC * finalAcetic) : 0;
                 hConcFromEquilibrium = approxHFromHA;
            }
            const totalHConc = hclRemaining + hConcFromEquilibrium;
            const pH = totalHConc > 1e-14 ? -Math.log10(totalHConc) : 14;
            const waterHConc = hclAdded > 1e-9 ? hclAdded : 1e-7;
            const waterPH = -Math.log10(waterHConc);
            return { pH, waterPH };
        }


        // Update the UI with calculation results
        function updateUI() {
            const result = calculateEquilibrium();

            // Update pH values
            if (hclConc === 0) {
                initialPHValue = result.pH;
                initialPh.textContent = result.pH.toFixed(2);
            }
            currentPh.textContent = result.pH.toFixed(2);
            const pHChangeValue = result.pH - initialPHValue;
            phChange.textContent = pHChangeValue.toFixed(2);

            // Update Henderson-Hasselbalch
             if (result.acetateConc > 1e-9 && result.aceticConc > 1e-9) {
                hhEquationValues.textContent = `${result.pH.toFixed(2)} = ${PKA_ACETIC.toFixed(2)} + log(${result.acetateConc.toFixed(3)}/${result.aceticConc.toFixed(3)})`;
            } else if (result.acetateConc <= 1e-9 && hclConc > 0) {
                 hhEquationValues.textContent = "Buffer base depleted";
             } else if (result.aceticConc <= 1e-9) {
                 hhEquationValues.textContent = "Buffer acid depleted";
             } else {
                 hhEquationValues.textContent = "Calculation Details"; // Fallback
             }

            // Update buffer capacity progress bar
             // bufferCapacityProgress is the indicator div now
            bufferCapacityProgress.style.width = `${result.bufferCapacityScore * 100}%`;


            // Update concentration chart
            if (concentrationChart) {
                concentrationChart.data.datasets[0].data = [
                    result.aceticConc, result.acetateConc, result.naConc, result.hConc, result.clConc
                ];
                concentrationChart.update('none'); // 'none' prevents animation flicker
            }

            // Update pH curve chart
            if (phCurveChart) {
                const curveData = updatePHCurveData();
                phCurveChart.data.labels = curveData.labels;
                phCurveChart.data.datasets[0].data = curveData.bufferPHPoints;
                phCurveChart.data.datasets[1].data = curveData.waterPHPoints;
                phCurveChart.update('none'); // 'none' prevents animation flicker
            }

            // Update visualization
            updateVisualization(result);

             // Update slider visuals
            updateSliderVisual(aceticConcentration, aceticRange, aceticThumb);
            updateSliderVisual(acetateConcentration, acetateRange, acetateThumb);
            updateSliderVisual(hclConcentration, hclRange, hclThumb);

            return result;
        }

        // Create and manage particles for visualization (logic unchanged)
        function updateVisualization(result) {
             if (animationFrame) cancelAnimationFrame(animationFrame); // Stop previous animation
            visualization.innerHTML = '';
            particles = [];
            const maxParticles = 250; // Increased slightly
            const scaleFactor = 1 / Math.max(result.aceticConc, result.acetateConc, result.naConc, result.hConc, result.clConc, 1e-9); // Avoid division by zero

            let numAcetic = Math.round(result.aceticConc * scaleFactor * 50); // Base scaling
            let numAcetate = Math.round(result.acetateConc * scaleFactor * 50);
            let numNa = Math.round(result.naConc * scaleFactor * 50);
            // Scale H+ and Cl- differently as their relative amounts can vary hugely
            let numH = Math.max(1, Math.min(50, Math.round(result.hConc * scaleFactor * 50 + Math.log10(result.hConc / 1e-7) * 5))); // Log scale for visibility
            let numCl = Math.max(0, Math.min(50, Math.round(result.clConc * scaleFactor * 50)));

             // Normalize to maxParticles if total exceeds limit
             const totalCalculated = numAcetic + numAcetate + numNa + numH + numCl;
             if (totalCalculated > maxParticles) {
                 const normFactor = maxParticles / totalCalculated;
                 numAcetic = Math.round(numAcetic * normFactor);
                 numAcetate = Math.round(numAcetate * normFactor);
                 numNa = Math.round(numNa * normFactor);
                 numH = Math.round(numH * normFactor);
                 numCl = Math.round(numCl * normFactor);
             }

            // Ensure minimum visibility if concentration > 0
            if (result.aceticConc > 1e-9 && numAcetic === 0) numAcetic = 1;
            if (result.acetateConc > 1e-9 && numAcetate === 0) numAcetate = 1;
            if (result.naConc > 1e-9 && numNa === 0) numNa = 1;
            if (result.hConc > 1e-9 && numH === 0) numH = 1;
            if (result.clConc > 1e-9 && numCl === 0) numCl = 1;


            for (let i = 0; i < numAcetic; i++) createParticle('acetic', 'yellow-500', '10px');
            for (let i = 0; i < numAcetate; i++) createParticle('acetate', 'green-500', '9px');
            for (let i = 0; i < numNa; i++) createParticle('na', 'purple-500', '7px');
            for (let i = 0; i < numH; i++) createParticle('h', 'red-500', '4px');
            for (let i = 0; i < numCl; i++) createParticle('cl', 'blue-500', '7px');

            animateParticles();
        }

        function createParticle(type, colorClass, size) {
            const particle = document.createElement('div');
            particle.className = `absolute rounded-full bg-${colorClass} opacity-80`; // Added opacity
            particle.style.width = size;
            particle.style.height = size;
            const x = Math.random() * 98 + 1; // Keep away from exact edges
            const y = Math.random() * 98 + 1;
            particle.style.left = `${x}%`;
            particle.style.top = `${y}%`;
            visualization.appendChild(particle);
            particles.push({ element: particle, x: x, y: y, vx: (Math.random() - 0.5) * 0.6, vy: (Math.random() - 0.5) * 0.6 }); // Slightly slower
        }

        function animateParticles() {
            function updatePositions() {
                const bounds = visualization.getBoundingClientRect();
                particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy;
                    // More robust boundary check
                    const particleSizePx = parseFloat(p.element.style.width);
                    const boundaryPaddingPercent = (particleSizePx / bounds.width) * 100 / 2; // Adjust based on particle size

                    if (p.x <= boundaryPaddingPercent || p.x >= 100 - boundaryPaddingPercent) p.vx *= -1;
                    if (p.y <= boundaryPaddingPercent || p.y >= 100 - boundaryPaddingPercent) p.vy *= -1;
                     // Clamp position to prevent sticking
                     p.x = Math.max(boundaryPaddingPercent, Math.min(100 - boundaryPaddingPercent, p.x));
                     p.y = Math.max(boundaryPaddingPercent, Math.min(100 - boundaryPaddingPercent, p.y));

                    p.element.style.transform = `translate(${p.x.toFixed(2)}%, ${p.y.toFixed(2)}%)`; // Use transform for better performance
                     p.element.style.left = '0%'; // Base position is top-left
                     p.element.style.top = '0%';
                });
                animationFrame = requestAnimationFrame(updatePositions);
            }
            if (animationFrame) cancelAnimationFrame(animationFrame);
             animationFrame = requestAnimationFrame(updatePositions);
        }

        // Initialize the simulation
        function initSimulation() {
            initCharts();
            aceticConc = parseFloat(aceticConcentration.value);
            acetateConc = parseFloat(acetateConcentration.value);
            hclConc = parseFloat(hclConcentration.value);
            aceticValue.textContent = aceticConc.toFixed(3);
            acetateValue.textContent = acetateConc.toFixed(3);
            hclValue.textContent = hclConc.toFixed(3);
            kaValue.textContent = KA_ACETIC.toExponential(1).replace('e-', ' × 10⁻');

            const result = updateUI(); // Initial UI update includes slider visuals
            initialPHValue = result.pH;
            initialPh.textContent = initialPHValue.toFixed(2); // Set initial pH explicitly

        }

        // Event Listeners
        aceticConcentration.addEventListener('input', () => {
            aceticConc = parseFloat(aceticConcentration.value);
            aceticValue.textContent = aceticConc.toFixed(3);
            updateUI();
        });

        acetateConcentration.addEventListener('input', () => {
            acetateConc = parseFloat(acetateConcentration.value);
            acetateValue.textContent = acetateConc.toFixed(3);
            updateUI();
        });

        hclConcentration.addEventListener('input', () => {
            hclConc = parseFloat(hclConcentration.value);
            hclValue.textContent = hclConc.toFixed(3);
            updateUI();
        });

        resetBtn.addEventListener('click', () => {
            aceticConcentration.value = 0.1;
            acetateConcentration.value = 0.1;
            hclConcentration.value = 0;
            aceticConc = 0.1; acetateConc = 0.1; hclConc = 0;
            aceticValue.textContent = aceticConc.toFixed(3);
            acetateValue.textContent = acetateConc.toFixed(3);
            hclValue.textContent = hclConc.toFixed(3);
            const result = updateUI();
            initialPHValue = result.pH;
             initialPh.textContent = initialPHValue.toFixed(2); // Ensure initial pH resets visually
             currentPh.textContent = initialPHValue.toFixed(2);
             phChange.textContent = "0.00";
        });

        // Handle dark mode changes for chart re-styling
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            applyDarkModePreference(); // Apply dark class
            // Short delay to allow CSS variables to update before redrawing charts
            setTimeout(() => {
                initCharts(); // Re-initialize charts with new theme colors
                updateUI();   // Redraw UI elements
            }, 50);
        });

        // Initialize after DOM is ready
        document.addEventListener('DOMContentLoaded', initSimulation);

    </script>
</body>
</html>