<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acetic Acid/Sodium Acetate Buffer Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Shadcn/ui Inspired CSS Variables */
        :root {
            --background: 0 0% 100%; /* white */
            --foreground: 222.2 84% 4.9%; /* near black */
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 248 57% 57%; /* Muted Purple/Blue */
            --primary-foreground: 0 0% 100%; /* white */
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%; /* Light gray for light mode track */
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 248 57% 57%; /* primary */
            --radius: 0.5rem;
        }

        .dark {
            --background: 222.2 84% 4.9%; /* near black */
            --foreground: 210 40% 98%; /* near white */
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 248 57% 67%; /* Lighter primary for dark */
            --primary-foreground: 222.2 47.4% 11.2%; /* dark */
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%; /* Dark gray for dark mode track */
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 248 57% 67%; /* primary */
        }

        /* Apply base styles */
        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: background-color 0.2s, color 0.2s;
        }

        /* Style range inputs slightly better */
         input[type="range"] {
             height: 0.5rem; /* h-2 */
             cursor: pointer;
             appearance: none;
             border-radius: 0.5rem; /* rounded-lg */
             background-color: hsl(var(--muted)); /* Use muted for track */
             width: 100%;
             overflow: hidden; /* Clip thumb overflow */
         }
         /* Thumb styles */
         input[type="range"]::-webkit-slider-thumb {
             appearance: none;
             width: 1rem; /* w-4 */
             height: 1rem; /* h-4 */
             background-color: hsl(var(--primary));
             border-radius: 9999px; /* rounded-full */
             cursor: pointer;
             /* Shadcn often uses a subtle border on thumbs */
             border: 2px solid hsl(var(--background));
             box-shadow: 0 0 0 1px hsl(var(--primary)); /* Optional ring effect */

         }
         input[type="range"]::-moz-range-thumb {
             width: 1rem;
             height: 1rem;
             background-color: hsl(var(--primary));
             border-radius: 9999px;
             cursor: pointer;
             border: 2px solid hsl(var(--background));
             box-shadow: 0 0 0 1px hsl(var(--primary));
         }
         /* Style the track fill for WebKit (Safari, Chrome) - Optional but nice */
        input[type="range"]::-webkit-slider-runnable-track {
            height: 0.5rem;
            background: hsl(var(--muted)); /* Full track color */
            border-radius: 0.5rem;
        }

    </style>
    <script>
        tailwind.config = {
            darkMode: 'class', // Ensure dark mode is activated by class
            theme: {
                extend: {
                    colors: {
                        border: 'hsl(var(--border))',
                        input: 'hsl(var(--input))',
                        ring: 'hsl(var(--ring))',
                        background: 'hsl(var(--background))',
                        foreground: 'hsl(var(--foreground))',
                        primary: {
                            DEFAULT: 'hsl(var(--primary))',
                            foreground: 'hsl(var(--primary-foreground))',
                        },
                        secondary: {
                            DEFAULT: 'hsl(var(--secondary))',
                            foreground: 'hsl(var(--secondary-foreground))',
                        },
                        destructive: {
                            DEFAULT: 'hsl(var(--destructive))',
                            foreground: 'hsl(var(--destructive-foreground))',
                        },
                        muted: {
                            DEFAULT: 'hsl(var(--muted))',
                            foreground: 'hsl(var(--muted-foreground))',
                        },
                        accent: {
                            DEFAULT: 'hsl(var(--accent))',
                            foreground: 'hsl(var(--accent-foreground))',
                        },
                        popover: {
                            DEFAULT: 'hsl(var(--popover))',
                            foreground: 'hsl(var(--popover-foreground))',
                        },
                        card: {
                            DEFAULT: 'hsl(var(--card))',
                            foreground: 'hsl(var(--card-foreground))',
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                }
            }
        }
    </script>
</head>
<!-- Apply base theme classes -->
<body class="bg-background text-foreground">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <h1 class="text-3xl font-bold text-center mb-4 text-primary">Acetic Acid/Sodium Acetate Buffer Simulation</h1>
        <p class="text-center text-muted-foreground mb-8">Demonstrating buffer action when HCl is added to the system</p>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Controls Panel -->
            <!-- Card styling -->
            <div class="bg-card text-card-foreground border border-border rounded-lg p-6 shadow-sm">
                <h2 class="text-xl font-semibold mb-4 tracking-tight">Buffer Components</h2>

                <!-- Acetic Acid Concentration -->
                <div class="mb-6">
                     <!-- Adjusted text -->
                    <label class="block mb-2 text-sm font-medium text-foreground" for="acetic-concentration">
                        Acetic Acid Concentration (M):
                        <span id="acetic-value" class="ml-2 font-bold">0.100</span>
                    </label>
                    <!-- Range input styled via CSS -->
                    <input type="range" id="acetic-concentration" min="0.01" max="0.5" step="0.01" value="0.1">
                </div>

                <!-- Sodium Acetate Concentration -->
                <div class="mb-6">
                    <label class="block mb-2 text-sm font-medium text-foreground" for="acetate-concentration">
                        Sodium Acetate Concentration (M):
                        <span id="acetate-value" class="ml-2 font-bold">0.100</span>
                    </label>
                    <input type="range" id="acetate-concentration" min="0.01" max="0.5" step="0.01" value="0.1">
                </div>

                <!-- HCl Addition -->
                <div class="mb-6">
                    <label class="block mb-2 text-sm font-medium text-foreground" for="hcl-concentration">
                        HCl Added (M):
                        <span id="hcl-value" class="ml-2 font-bold">0.000</span>
                    </label>
                    <input type="range" id="hcl-concentration" min="0" max="0.2" step="0.001" value="0">
                </div>

                <!-- Ka Value -->
                <div class="flex items-center mb-6 text-sm">
                    <span class="font-medium text-foreground">Ka of Acetic Acid:</span>
                    <span id="ka-value" class="ml-2 font-mono text-muted-foreground">1.8 × 10⁻⁵</span>
                    <span class="ml-2 font-medium text-muted-foreground">(pKa = 4.74)</span>
                </div>

                <div class="mb-6">
                    <!-- Button styling -->
                    <button id="reset-btn" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                        Reset Simulation
                    </button>
                </div>
            </div>

            <!-- pH and Buffer Capacity Panel -->
             <!-- Card styling -->
            <div class="bg-card text-card-foreground border border-border rounded-lg p-6 shadow-sm">
                <h2 class="text-xl font-semibold mb-4 tracking-tight">pH and Buffer Capacity</h2>

                <!-- pH Values -->
                <div class="mb-6 grid grid-cols-2 gap-4">
                     <!-- Inner card/box styling -->
                    <div class="bg-background border border-border p-3 rounded-md">
                        <h3 class="text-sm font-medium text-muted-foreground">Initial pH</h3>
                        <p id="initial-ph" class="text-2xl font-bold text-foreground">4.74</p>
                    </div>
                    <div class="bg-background border border-border p-3 rounded-md">
                        <h3 class="text-sm font-medium text-muted-foreground">Current pH</h3>
                        <p id="current-ph" class="text-2xl font-bold text-foreground">4.74</p>
                    </div>
                </div>

                <!-- Buffer Capacity Gauge -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-muted-foreground mb-2">Buffer Capacity</h3>
                     <!-- Gauge track: Use bg-muted for the track color -->
                    <div class="h-2 bg-muted rounded-full overflow-hidden">
                        <!-- Gauge bar: Use bg-primary for the fill color -->
                        <div id="buffer-capacity-bar" class="h-full bg-primary transition-all duration-300 ease-linear" style="width: 50%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-muted-foreground mt-1">
                        <span>Low</span>
                        <!-- Removed Medium text for better spacing on a simple bar -->
                        <span>High</span>
                    </div>
                </div>

                <!-- pH Change Info -->
                <div class="bg-background border border-border p-3 rounded-md mb-4">
                    <h3 class="text-sm font-medium text-muted-foreground">pH Change with HCl</h3>
                    <p id="ph-change" class="text-xl font-bold text-foreground">0.00</p>
                </div>

                <!-- Henderson-Hasselbalch Equation -->
                 <!-- Muted background for code/equation -->
                <div class="p-3 border border-border rounded-md bg-muted/50">
                    <h3 class="text-sm font-medium mb-2 text-foreground">Henderson-Hasselbalch Equation:</h3>
                    <p class="font-mono text-center text-sm text-muted-foreground">pH = pKa + log([CH₃COO⁻]/[CH₃COOH])</p>
                    <p id="hh-equation-values" class="font-mono text-center text-sm mt-2 text-muted-foreground">4.74 = 4.74 + log(0.1/0.1)</p>
                </div>
            </div>

            <!-- Visualization & Charts -->
             <!-- Card styling -->
            <div class="bg-card text-card-foreground border border-border rounded-lg p-6 shadow-sm">
                <h2 class="text-xl font-semibold mb-4 tracking-tight">Concentration Changes</h2>

                <!-- Concentration Chart -->
                <div class="w-full h-60 mb-4">
                    <canvas id="concentration-chart"></canvas>
                </div>

                <!-- pH vs HCl Chart -->
                <h3 class="text-md font-medium mt-4 mb-2 text-foreground">Buffer Action: pH vs HCl Added</h3>
                <div class="w-full h-40">
                    <canvas id="ph-curve-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Molecular Visualization -->
         <!-- Card styling -->
        <div class="mt-6 bg-card text-card-foreground border border-border rounded-lg p-6 shadow-sm">
            <h2 class="text-xl font-semibold mb-4 tracking-tight">Molecular Visualization</h2>
             <!-- Visualization area border and muted background -->
            <div id="visualization" class="border border-border rounded-md h-64 relative overflow-hidden bg-muted/30">
                <!-- Particles will be added here by JS -->
            </div>

            <!-- Legend styling -->
            <div class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-2 text-sm text-muted-foreground">
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-yellow-500 inline-block mr-2"></span>
                    <span>CH₃COOH</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-green-500 inline-block mr-2"></span>
                    <span>CH₃COO⁻</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-purple-500 inline-block mr-2"></span>
                    <span>Na⁺</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-red-500 inline-block mr-2"></span>
                    <span>H⁺</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-blue-500 inline-block mr-2"></span>
                    <span>Cl⁻</span>
                </div>
            </div>
        </div>

        <!-- Explanation -->
         <!-- Card styling -->
        <div class="mt-6 bg-card text-card-foreground border border-border rounded-lg p-6 shadow-sm">
            <h2 class="text-xl font-semibold mb-4 tracking-tight">Understanding Buffer Action</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                <div>
                    <h3 class="font-semibold mb-2 text-foreground">How This Buffer Works</h3>
                    <p class="mb-3 text-muted-foreground leading-relaxed">
                        A buffer is a solution that resists changes in pH when small amounts of acid or base are added. The acetic acid/sodium acetate buffer works through the following equilibrium:
                    </p>
                    <!-- Code block styling -->
                    <p class="text-center mb-3 font-mono bg-muted/50 border border-border rounded-md p-2 text-xs text-muted-foreground">
                        CH₃COOH(aq) ⇌ CH₃COO⁻(aq) + H⁺(aq)
                    </p>
                    <p class="mb-3 text-muted-foreground leading-relaxed">
                        When HCl is added, it dissociates completely:
                    </p>
                     <p class="text-center mb-3 font-mono bg-muted/50 border border-border rounded-md p-2 text-xs text-muted-foreground">
                        HCl(aq) → H⁺(aq) + Cl⁻(aq)
                    </p>
                    <p class="text-muted-foreground leading-relaxed">
                        The excess H⁺ ions react with acetate ions (CH₃COO⁻) to form acetic acid (CH₃COOH), minimizing the change in pH. This is the buffer action.
                    </p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2 text-foreground">Buffer Capacity Factors</h3>
                    <ul class="list-disc list-inside text-muted-foreground space-y-2 leading-relaxed">
                        <li>Buffer capacity is highest when [CH₃COOH] ≈ [CH₃COO⁻] (ratio ≈ 1:1)</li>
                        <li>Buffer capacity increases with higher total buffer concentration</li>
                        <li>A buffer is most effective when pH is within ±1 unit of the pKa (here, 3.74-5.74)</li>
                        <li>The buffer can be overwhelmed if excessive acid/base is added</li>
                        <li>The Henderson-Hasselbalch equation relates pH, pKa, and component concentrations</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to get color from CSS variable
        function getCssVariable(variable) {
            return getComputedStyle(document.documentElement).getPropertyValue(variable).trim();
        }
         // Function to convert HSL string to rgba for Chart.js
        function hslToRgba(hslString, alpha = 1) {
             if (!hslString) return `rgba(0,0,0, ${alpha})`; // Fallback if variable missing
             if (hslString.startsWith('rgba')) return hslString;
             if (hslString.startsWith('#')) return hslString; // Basic hex support

            try {
                 const [h, s, l] = hslString.split(' ').map((val, index) => {
                     return parseFloat(val.replace('%', ''));
                 });
                 const saturation = s / 100;
                 const lightness = l / 100;
                 let c = (1 - Math.abs(2 * lightness - 1)) * saturation;
                 let x = c * (1 - Math.abs((h / 60) % 2 - 1));
                 let m = lightness - c/2;
                 let r = 0, g = 0, b = 0;
                 if (0 <= h && h < 60) { r = c; g = x; b = 0; }
                 else if (60 <= h && h < 120) { r = x; g = c; b = 0; }
                 else if (120 <= h && h < 180) { r = 0; g = c; b = x; }
                 else if (180 <= h && h < 240) { r = 0; g = x; b = c; }
                 else if (240 <= h && h < 300) { r = x; g = 0; b = c; }
                 else if (300 <= h && h < 360) { r = c; g = 0; b = x; }
                 r = Math.round((r + m) * 255);
                 g = Math.round((g + m) * 255);
                 b = Math.round((b + m) * 255);
                 return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            } catch (e) {
                 console.error("Failed to parse HSL:", hslString, e);
                 return `rgba(0, 0, 0, ${alpha})`; // Fallback color
             }
         }

        // Initialize dark mode based on user preference or system setting
        function applyTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // Watch for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
             if (!('theme' in localStorage)) { // Only respect system change if no theme is explicitly set via localStorage
                applyTheme(); // Re-apply based on new system preference
                // Re-init charts on theme change
                 if (concentrationChart) concentrationChart.destroy();
                 if (phCurveChart) phCurveChart.destroy();
                 initCharts(); // Recreate charts with new theme colors
                 updateUI(); // Update UI elements based on new theme
             }
        });

        // DOM elements
        const aceticConcentration = document.getElementById('acetic-concentration');
        const aceticValue = document.getElementById('acetic-value');
        const acetateConcentration = document.getElementById('acetate-concentration');
        const acetateValue = document.getElementById('acetate-value');
        const hclConcentration = document.getElementById('hcl-concentration');
        const hclValue = document.getElementById('hcl-value');
        const kaValue = document.getElementById('ka-value');
        const initialPh = document.getElementById('initial-ph');
        const currentPh = document.getElementById('current-ph');
        const phChange = document.getElementById('ph-change');
        const hhEquationValues = document.getElementById('hh-equation-values');
        const bufferCapacityBar = document.getElementById('buffer-capacity-bar');
        const resetBtn = document.getElementById('reset-btn');
        const visualization = document.getElementById('visualization');

        // Charts
        let concentrationChart = null;
        let phCurveChart = null;

        // Constants
        const KA_ACETIC = 1.8e-5;
        const PKA_ACETIC = -Math.log10(KA_ACETIC);

        // State variables
        let aceticConc, acetateConc, hclConc; // Will be initialized in initSimulation
        let initialPHValue = 0;
        let particles = [];
        let animationFrame;

        // Initialize Charts
        function initCharts() {
             // Ensure theme is applied before getting colors
             applyTheme();

             // Get colors from CSS variables *after* ensuring theme is set
             const primaryHsl = getCssVariable('--primary');
             const foregroundHsl = getCssVariable('--foreground');
             const borderHsl = getCssVariable('--border');
             const popoverHsl = getCssVariable('--popover');
             const popoverForegroundHsl = getCssVariable('--popover-foreground');

             const primaryColor = hslToRgba(primaryHsl);
             const textColor = hslToRgba(foregroundHsl);
             const gridColor = hslToRgba(borderHsl, 0.5);
             const tooltipBgColor = hslToRgba(popoverHsl);
             const tooltipTextColor = hslToRgba(popoverForegroundHsl);
             const redColor = 'rgba(239, 68, 68, 0.7)'; // Explicit red for comparison curve

             // Particle colors (fixed for identification)
             const particleColorsRgba = {
                 acetic: 'rgba(245, 158, 11, 0.9)', acetate: 'rgba(16, 185, 129, 0.9)',
                 na: 'rgba(168, 85, 247, 0.9)', h: 'rgba(239, 68, 68, 0.9)',
                 cl: 'rgba(59, 130, 246, 0.9)'
             };

            // Concentration chart
            const concentrationCanvas = document.getElementById('concentration-chart');
            if (!concentrationCanvas) return;
            const concentrationCtx = concentrationCanvas.getContext('2d');
            if (!concentrationCtx) return;

            concentrationChart = new Chart(concentrationCtx, {
                type: 'bar',
                data: {
                    labels: ['CH₃COOH', 'CH₃COO⁻', 'Na⁺', 'H⁺', 'Cl⁻'],
                    datasets: [{
                        label: 'Concentration (M)',
                        data: [0, 0, 0, 0, 0], // Initial data
                        backgroundColor: [
                            particleColorsRgba.acetic, particleColorsRgba.acetate,
                            particleColorsRgba.na, particleColorsRgba.h, particleColorsRgba.cl,
                        ],
                        borderColor: hslToRgba(borderHsl), // Use theme border color
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                             backgroundColor: tooltipBgColor, titleColor: tooltipTextColor, bodyColor: tooltipTextColor,
                             callbacks: { label: ctx => ctx.raw < 0.001 ? `${ctx.raw.toExponential(3)} M` : `${ctx.raw.toFixed(4)} M` }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Concentration (M)', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                }
            });

            // pH Curve chart
            const phCurveCanvas = document.getElementById('ph-curve-chart');
            if (!phCurveCanvas) return;
            const phCurveCtx = phCurveCanvas.getContext('2d');
            if (!phCurveCtx) return;

            phCurveChart = new Chart(phCurveCtx, {
                type: 'line',
                data: { labels: [], datasets: [ /* datasets defined below */ ] }, // Initialize empty
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: textColor } },
                        tooltip: { backgroundColor: tooltipBgColor, titleColor: tooltipTextColor, bodyColor: tooltipTextColor }
                    },
                    scales: {
                        y: { title: { display: true, text: 'pH', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor } },
                        x: { title: { display: true, text: 'HCl Added (M)', color: textColor }, ticks: { color: textColor, maxRotation: 0, autoSkip: true, maxTicksLimit: 6 }, grid: { color: gridColor } }
                    }
                }
            });
             // Define datasets separately to easily use theme colors
            phCurveChart.data.datasets.push({
                label: 'Buffer Solution', data: [],
                borderColor: primaryColor,
                backgroundColor: primaryColor.replace(/rgba?\((\d+,\s*\d+,\s*\d+)(?:,\s*\d?\.?\d+)?\)/, `rgba($1, 0.1)`), // Add/set alpha to 0.1
                tension: 0.3, fill: true, pointRadius: 0, pointHoverRadius: 4, pointBackgroundColor: primaryColor
            });
            phCurveChart.data.datasets.push({
                 label: 'Water (No Buffer)', data: [],
                 borderColor: redColor,
                 backgroundColor: redColor.replace('0.7', '0.05'),
                 borderDash: [5, 5], tension: 0.3, fill: true, pointRadius: 0, pointHoverRadius: 4, pointBackgroundColor: redColor
            });
            phCurveChart.update(); // Update chart with datasets
        }

        // Calculate equilibrium (Logic unchanged, includes floating point safety)
        function calculateEquilibrium() {
            const initialAcetic = aceticConc;
            const initialAcetate = acetateConc;
            const initialHCl = hclConc;
            const acetateConsumed = Math.min(initialAcetate, initialHCl);
            const hclRemaining = initialHCl - acetateConsumed;
            const finalAcetate = initialAcetate - acetateConsumed;
            const finalAcetic = initialAcetic + acetateConsumed;
            const finalNa = initialAcetate; // Assumes Na+ comes only from Sodium Acetate
            const finalCl = initialHCl;

            let hConcFromHCl = hclRemaining;
            let hConcFromEquilibrium = 1e-14; // Baseline H+

            if (finalAcetate > 1e-9 && finalAcetic > 1e-9) { // Buffer region
                hConcFromEquilibrium = KA_ACETIC * (finalAcetic / finalAcetate);
            } else if (finalAcetic > 1e-9) { // Acetate depleted, only acetic acid left (besides HCl)
                 hConcFromEquilibrium = Math.sqrt(KA_ACETIC * finalAcetic + (KA_ACETIC*KA_ACETIC)/4) - KA_ACETIC/2; // Quadratic solution for weak acid dissociation
            } else { // Only HCl or water left
                hConcFromEquilibrium = (hclRemaining > 1e-9) ? 0 : 1e-7; // H+ from water if only water
            }

            const totalHConc = Math.max(hConcFromHCl + hConcFromEquilibrium, 1e-14);
            const pH = -Math.log10(totalHConc);

            const waterHConc = initialHCl > 1e-9 ? initialHCl : 1e-7;
            const waterPH = -Math.log10(waterHConc);

            const ratio = (finalAcetate > 1e-9 && finalAcetic > 1e-9) ? finalAcetate / finalAcetic : 0;
            const logRatioTerm = (ratio > 0) ? Math.abs(Math.log10(ratio)) : 10;
            const bufferCapacityRatio = 1 - Math.min(logRatioTerm / 2, 1);

            const totalBufferConcentration = finalAcetic + finalAcetate;
             const maxConsideredConc = 0.5; // Concentration at which capacity boost maxes out
            const normalizedConcentration = Math.min(totalBufferConcentration / maxConsideredConc, 1);

            const bufferCapacityScore = bufferCapacityRatio * normalizedConcentration;

            return {
                aceticConc: Math.max(0, finalAcetic), acetateConc: Math.max(0, finalAcetate),
                naConc: Math.max(0, finalNa), hConc: totalHConc, clConc: Math.max(0, finalCl),
                pH: pH, waterPH: waterPH,
                bufferCapacityScore: Math.max(0, Math.min(1, bufferCapacityScore)), // Clamp score 0-1
                ratio: ratio
            };
        }

        // Update pH curve data (Logic unchanged)
        function updatePHCurveData() {
            const currentAcetic = aceticConc; const currentAcetate = acetateConc;
            const currentHclSliderValue = parseFloat(hclConcentration.value);
            const hclPoints = [], bufferPHPoints = [], waterPHPoints = [];
            const numPoints = 41; const maxHCl = parseFloat(hclConcentration.max);

            for (let i = 0; i < numPoints; i++) {
                const pointHCl = (i / (numPoints - 1)) * maxHCl;
                hclPoints.push(pointHCl.toFixed(3));
                hclConc = pointHCl; // Temporarily set for calculation
                const result = calculateEquilibrium();
                bufferPHPoints.push(result.pH);
                waterPHPoints.push(result.waterPH);
            }
            // Restore actual state
            hclConc = currentHclSliderValue; aceticConc = currentAcetic; acetateConc = currentAcetate;
            return { labels: hclPoints, bufferPHPoints, waterPHPoints };
        }

        // Update UI Elements
        function updateUI() {
            if (!concentrationChart || !phCurveChart) {
                 console.warn("Charts not ready, skipping UI update");
                 return; // Don't update if charts aren't initialized
             }
            const result = calculateEquilibrium();

             // Update pH values only if HCl is 0 or if initialPHValue is already set
             if (hclConc === 0 || initialPHValue === 0) {
                 initialPHValue = result.pH;
                 initialPh.textContent = result.pH.toFixed(2);
             }

            currentPh.textContent = result.pH.toFixed(2);
            const pHChangeValue = result.pH - initialPHValue;
            phChange.textContent = pHChangeValue.toFixed(2);

            // Update HH equation display
            if (result.acetateConc > 1e-9 && result.aceticConc > 1e-9) {
                 hhEquationValues.textContent = `${result.pH.toFixed(2)} = ${PKA_ACETIC.toFixed(2)} + log(${result.acetateConc.toFixed(3)}/${result.aceticConc.toFixed(3)})`;
             } else if (result.hclConc > result.acetateConc && result.acetateConc < 1e-9) {
                 hhEquationValues.textContent = "pH ≈ -log[HCl excess]";
             } else if (result.aceticConc > 1e-9) {
                 hhEquationValues.textContent = "pH dominated by acetic acid";
             } else {
                 hhEquationValues.textContent = "Buffer exhausted";
             }

            // Update buffer capacity bar width (ensure it's between 0% and 100%)
            bufferCapacityBar.style.width = `${result.bufferCapacityScore * 100}%`;

            // Update concentration chart data
            concentrationChart.data.datasets[0].data = [
                result.aceticConc, result.acetateConc, result.naConc, result.hConc, result.clConc
            ];
            concentrationChart.update('none'); // 'none' prevents animation on update

            // Update pH curve chart data
            const curveData = updatePHCurveData();
            phCurveChart.data.labels = curveData.labels;
            phCurveChart.data.datasets[0].data = curveData.bufferPHPoints;
            phCurveChart.data.datasets[1].data = curveData.waterPHPoints;
            phCurveChart.update('none');

            updateVisualization(result); // Update particles
            return result; // Return result for potential use elsewhere (like init)
        }

        // Visualization Update (Logic unchanged)
        function updateVisualization(result) {
            if (!visualization) return; // Ensure element exists
            visualization.innerHTML = ''; particles = [];
            if (animationFrame) cancelAnimationFrame(animationFrame);

            const maxParticles = 250;
            const totalConc = result.aceticConc + result.acetateConc + result.naConc + result.hConc + result.clConc;
            if (totalConc < 1e-9) { animateParticles(); return; } // Start animation even if empty

             let numAcetic = result.aceticConc > 1e-9 ? Math.max(1, Math.round((result.aceticConc / totalConc) * maxParticles)) : 0;
             let numAcetate = result.acetateConc > 1e-9 ? Math.max(1, Math.round((result.acetateConc / totalConc) * maxParticles)) : 0;
             let numNa = result.naConc > 1e-9 ? Math.max(1, Math.round((result.naConc / totalConc) * maxParticles)) : 0;
             let numH = result.hConc > 1e-9 ? Math.max(1, Math.round((result.hConc / totalConc) * maxParticles)) : 0;
             let numCl = result.clConc > 1e-9 ? Math.max(1, Math.round((result.clConc / totalConc) * maxParticles)) : 0;

             const colors = { acetic: 'bg-yellow-500', acetate: 'bg-green-500', na: 'bg-purple-500', h: 'bg-red-500', cl: 'bg-blue-500' };

             for (let i = 0; i < numAcetic; i++) createParticle('acetic', colors.acetic);
             for (let i = 0; i < numAcetate; i++) createParticle('acetate', colors.acetate);
             for (let i = 0; i < numNa; i++) createParticle('na', colors.na);
             for (let i = 0; i < numH; i++) createParticle('h', colors.h);
             for (let i = 0; i < numCl; i++) createParticle('cl', colors.cl);

            animateParticles();
        }

        // Create Particle (Logic unchanged)
        function createParticle(type, colorClass) {
            const particle = document.createElement('div');
            let size = '6px';
            if (type === 'acetic') size = '10px'; else if (type === 'acetate') size = '9px';
            else if (type === 'na' || type === 'cl') size = '7px'; else if (type === 'h') size = '4px';
            particle.className = `absolute rounded-full ${colorClass} shadow-sm`;
            particle.style.width = size; particle.style.height = size;
            particle.style.willChange = 'transform';

            const visRect = visualization.getBoundingClientRect();
            const visWidth = visRect.width || 300; const visHeight = visRect.height || 256;
            const pSize = parseFloat(size);
            const maxX = Math.max(0, visWidth - pSize); const maxY = Math.max(0, visHeight - pSize);
            const x = Math.random() * maxX; const y = Math.random() * maxY;
            particle.style.transform = `translate(${x}px, ${y}px)`;
            visualization.appendChild(particle);
            particles.push({ element: particle, x: x, y: y, vx: (Math.random() - 0.5) * 0.4, vy: (Math.random() - 0.5) * 0.4, size: pSize });
        }

        // Animate Particles (Logic unchanged)
        function animateParticles() {
            const visRect = visualization.getBoundingClientRect();
            const visWidth = visRect.width || 300; const visHeight = visRect.height || 256;
            function updatePositions() {
                particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy;
                    if (p.x <= 0 || p.x >= visWidth - p.size) { p.vx *= -1; p.x = Math.max(0, Math.min(p.x, visWidth - p.size)); } // Clamp position on bounce
                    if (p.y <= 0 || p.y >= visHeight - p.size) { p.vy *= -1; p.y = Math.max(0, Math.min(p.y, visHeight - p.size)); }
                    p.element.style.transform = `translate(${p.x}px, ${p.y}px)`;
                });
                animationFrame = requestAnimationFrame(updatePositions);
            }
            if (animationFrame) cancelAnimationFrame(animationFrame);
            animationFrame = requestAnimationFrame(updatePositions);
        }

        // Initialize Simulation State and UI
        function initSimulation() {
            // Set initial state from HTML values
            aceticConc = parseFloat(aceticConcentration.value);
            acetateConc = parseFloat(acetateConcentration.value);
            hclConc = parseFloat(hclConcentration.value);

            // Update labels
            aceticValue.textContent = aceticConc.toFixed(3);
            acetateValue.textContent = acetateConc.toFixed(3);
            hclValue.textContent = hclConc.toFixed(3);
            kaValue.textContent = KA_ACETIC.toExponential(1).replace('e-', ' × 10⁻');

             // Destroy existing charts if any (e.g., on reset or theme change)
            if (concentrationChart) concentrationChart.destroy();
            if (phCurveChart) phCurveChart.destroy();

            // Initialize charts (which also applies theme)
            initCharts();

            // Perform initial calculation and update all UI elements
            const result = calculateEquilibrium(); // Calculate with initial values
            initialPHValue = result.pH; // Set the baseline pH
            updateUI(); // Update everything based on initial state

            // Ensure initial pH text content is set correctly after the first updateUI call
            initialPh.textContent = initialPHValue.toFixed(2);
        }

        // Event Listeners
        aceticConcentration.addEventListener('input', () => {
            aceticConc = parseFloat(aceticConcentration.value);
            aceticValue.textContent = aceticConc.toFixed(3);
            requestAnimationFrame(updateUI); // Use rAF for smoother updates on slider drag
        });

        acetateConcentration.addEventListener('input', () => {
            acetateConc = parseFloat(acetateConcentration.value);
            acetateValue.textContent = acetateConc.toFixed(3);
            requestAnimationFrame(updateUI);
        });

        hclConcentration.addEventListener('input', () => {
            hclConc = parseFloat(hclConcentration.value);
            hclValue.textContent = hclConc.toFixed(3);
            requestAnimationFrame(updateUI);
        });

        resetBtn.addEventListener('click', () => {
             // Set sliders back to default values
             aceticConcentration.value = 0.1;
             acetateConcentration.value = 0.1;
             hclConcentration.value = 0;

             // Re-run the full initialization process
             initSimulation();
        });

         // Debounced resize handler
         let resizeTimer;
         window.addEventListener('resize', () => {
             clearTimeout(resizeTimer);
             resizeTimer = setTimeout(() => {
                 // Re-initialize charts on resize might be needed if aspect ratio changes drastically
                 // Or just redraw visualization if positions are calculated in % (they are in px here, so less critical)
                 if (particles.length > 0) {
                     // Re-trigger visualization update which recalculates bounds/positions
                     updateVisualization(calculateEquilibrium()); // Use current state
                 }
             }, 250);
         });

        // --- Initial Setup ---
        // Apply theme immediately on load
        applyTheme();
        // Initialize the simulation after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initSimulation);

    </script>
</body>
</html>
