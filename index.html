<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acetic Acid/Sodium Acetate Buffer Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Shadcn/ui Inspired CSS Variables */
        :root {
            --background: 0 0% 100%; /* white */
            --foreground: 222.2 84% 4.9%; /* near black */
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 248 57% 57%; /* Muted Purple/Blue similar to example */
            --primary-foreground: 0 0% 100%; /* white */
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 248 57% 57%; /* primary */
            --radius: 0.5rem;
        }

        .dark {
            --background: 222.2 84% 4.9%; /* near black */
            --foreground: 210 40% 98%; /* near white */
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 248 57% 67%; /* Lighter primary for dark */
            --primary-foreground: 222.2 47.4% 11.2%; /* dark */
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 248 57% 67%; /* primary */
        }

        /* Apply base styles */
        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: background-color 0.2s, color 0.2s;
        }

        /* Style range inputs slightly better */
         input[type="range"] {
             height: 0.5rem; /* h-2 */
             cursor: pointer;
             appearance: none;
             border-radius: 0.5rem; /* rounded-lg */
             background-color: hsl(var(--primary) / 0.2); /* primary background with opacity */
             width: 100%;
         }
         /* Thumb styles */
         input[type="range"]::-webkit-slider-thumb {
             appearance: none;
             width: 1rem; /* w-4 */
             height: 1rem; /* h-4 */
             background-color: hsl(var(--primary));
             border-radius: 9999px; /* rounded-full */
             cursor: pointer;
         }
         input[type="range"]::-moz-range-thumb {
             width: 1rem;
             height: 1rem;
             background-color: hsl(var(--primary));
             border-radius: 9999px;
             cursor: pointer;
             border: none; /* Remove default border in Firefox */
         }

    </style>
    <script>
        tailwind.config = {
            darkMode: 'class', // Ensure dark mode is activated by class
            theme: {
                extend: {
                    colors: {
                        border: 'hsl(var(--border))',
                        input: 'hsl(var(--input))',
                        ring: 'hsl(var(--ring))',
                        background: 'hsl(var(--background))',
                        foreground: 'hsl(var(--foreground))',
                        primary: {
                            DEFAULT: 'hsl(var(--primary))',
                            foreground: 'hsl(var(--primary-foreground))',
                        },
                        secondary: {
                            DEFAULT: 'hsl(var(--secondary))',
                            foreground: 'hsl(var(--secondary-foreground))',
                        },
                        destructive: {
                            DEFAULT: 'hsl(var(--destructive))',
                            foreground: 'hsl(var(--destructive-foreground))',
                        },
                        muted: {
                            DEFAULT: 'hsl(var(--muted))',
                            foreground: 'hsl(var(--muted-foreground))',
                        },
                        accent: {
                            DEFAULT: 'hsl(var(--accent))',
                            foreground: 'hsl(var(--accent-foreground))',
                        },
                        popover: {
                            DEFAULT: 'hsl(var(--popover))',
                            foreground: 'hsl(var(--popover-foreground))',
                        },
                        card: {
                            DEFAULT: 'hsl(var(--card))',
                            foreground: 'hsl(var(--card-foreground))',
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-background text-foreground"> {/* Use CSS variables */}
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <h1 class="text-3xl font-bold text-center mb-4 text-primary">Acetic Acid/Sodium Acetate Buffer Simulation</h1>
        <p class="text-center text-muted-foreground mb-8">Demonstrating buffer action when HCl is added to the system</p>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Controls Panel -->
            <div class="bg-card text-card-foreground border border-border rounded-lg p-6 shadow-sm"> {/* Card styling */}
                <h2 class="text-xl font-semibold mb-4 tracking-tight">Buffer Components</h2>

                <!-- Acetic Acid Concentration -->
                <div class="mb-6">
                    <label class="block mb-2 text-sm font-medium text-foreground" for="acetic-concentration"> {/* Adjusted text */}
                        Acetic Acid Concentration (M):
                        <span id="acetic-value" class="ml-2 font-bold">0.100</span>
                    </label>
                    {/* Use custom slider styles via CSS + accent-primary for fallback */}
                    <input type="range" id="acetic-concentration" min="0.01" max="0.5" step="0.01" value="0.1" class="accent-primary">
                </div>

                <!-- Sodium Acetate Concentration -->
                <div class="mb-6">
                    <label class="block mb-2 text-sm font-medium text-foreground" for="acetate-concentration">
                        Sodium Acetate Concentration (M):
                        <span id="acetate-value" class="ml-2 font-bold">0.100</span>
                    </label>
                    <input type="range" id="acetate-concentration" min="0.01" max="0.5" step="0.01" value="0.1" class="accent-primary">
                </div>

                <!-- HCl Addition -->
                <div class="mb-6">
                    <label class="block mb-2 text-sm font-medium text-foreground" for="hcl-concentration">
                        HCl Added (M):
                        <span id="hcl-value" class="ml-2 font-bold">0.000</span>
                    </label>
                    <input type="range" id="hcl-concentration" min="0" max="0.2" step="0.001" value="0" class="accent-primary">
                </div>

                <!-- Ka Value -->
                <div class="flex items-center mb-6 text-sm">
                    <span class="font-medium text-foreground">Ka of Acetic Acid:</span>
                    <span id="ka-value" class="ml-2 font-mono text-muted-foreground">1.8 × 10⁻⁵</span>
                    <span class="ml-2 font-medium text-muted-foreground">(pKa = 4.74)</span>
                </div>

                <div class="mb-6">
                    {/* Button styling */}
                    <button id="reset-btn" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                        Reset Simulation
                    </button>
                </div>
            </div>

            <!-- pH and Buffer Capacity Panel -->
            <div class="bg-card text-card-foreground border border-border rounded-lg p-6 shadow-sm"> {/* Card styling */}
                <h2 class="text-xl font-semibold mb-4 tracking-tight">pH and Buffer Capacity</h2>

                <!-- pH Values -->
                <div class="mb-6 grid grid-cols-2 gap-4">
                     {/* Inner card/box styling */}
                    <div class="bg-background border border-border p-3 rounded-md">
                        <h3 class="text-sm font-medium text-muted-foreground">Initial pH</h3>
                        <p id="initial-ph" class="text-2xl font-bold text-foreground">4.74</p>
                    </div>
                    <div class="bg-background border border-border p-3 rounded-md">
                        <h3 class="text-sm font-medium text-muted-foreground">Current pH</h3>
                        <p id="current-ph" class="text-2xl font-bold text-foreground">4.74</p>
                    </div>
                </div>

                <!-- Buffer Capacity Gauge -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-muted-foreground mb-2">Buffer Capacity</h3>
                     {/* Gauge track */}
                    <div class="h-2 bg-muted rounded-full overflow-hidden">
                        {/* Gauge bar - using primary color */}
                        <div id="buffer-capacity-bar" class="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 transition-all duration-300" style="width: 50%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-muted-foreground mt-1">
                        <span>Low</span>
                        <span>Medium</span>
                        <span>High</span>
                    </div>
                </div>

                <!-- pH Change Info -->
                <div class="bg-background border border-border p-3 rounded-md mb-4">
                    <h3 class="text-sm font-medium text-muted-foreground">pH Change with HCl</h3>
                    <p id="ph-change" class="text-xl font-bold text-foreground">0.00</p>
                </div>

                <!-- Henderson-Hasselbalch Equation -->
                 {/* Muted background for code/equation */}
                <div class="p-3 border border-border rounded-md bg-muted/50">
                    <h3 class="text-sm font-medium mb-2 text-foreground">Henderson-Hasselbalch Equation:</h3>
                    <p class="font-mono text-center text-sm text-muted-foreground">pH = pKa + log([CH₃COO⁻]/[CH₃COOH])</p>
                    <p id="hh-equation-values" class="font-mono text-center text-sm mt-2 text-muted-foreground">4.74 = 4.74 + log(0.1/0.1)</p>
                </div>
            </div>

            <!-- Visualization & Charts -->
            <div class="bg-card text-card-foreground border border-border rounded-lg p-6 shadow-sm"> {/* Card styling */}
                <h2 class="text-xl font-semibold mb-4 tracking-tight">Concentration Changes</h2>

                <!-- Concentration Chart -->
                <div class="w-full h-60 mb-4">
                    <canvas id="concentration-chart"></canvas>
                </div>

                <!-- pH vs HCl Chart -->
                <h3 class="text-md font-medium mt-4 mb-2 text-foreground">Buffer Action: pH vs HCl Added</h3>
                <div class="w-full h-40">
                    <canvas id="ph-curve-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Molecular Visualization -->
        <div class="mt-6 bg-card text-card-foreground border border-border rounded-lg p-6 shadow-sm"> {/* Card styling */}
            <h2 class="text-xl font-semibold mb-4 tracking-tight">Molecular Visualization</h2>
             {/* Visualization area border and muted background */}
            <div id="visualization" class="border border-border rounded-md h-64 relative overflow-hidden bg-muted/30">
                <!-- Particles will be added here by JS -->
            </div>

            {/* Legend styling */}
            <div class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-2 text-sm text-muted-foreground">
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-yellow-500 inline-block mr-2"></span>
                    <span>CH₃COOH</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-green-500 inline-block mr-2"></span>
                    <span>CH₃COO⁻</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-purple-500 inline-block mr-2"></span>
                    <span>Na⁺</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-red-500 inline-block mr-2"></span>
                    <span>H⁺</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-blue-500 inline-block mr-2"></span>
                    <span>Cl⁻</span>
                </div>
            </div>
        </div>

        <!-- Explanation -->
        <div class="mt-6 bg-card text-card-foreground border border-border rounded-lg p-6 shadow-sm"> {/* Card styling */}
            <h2 class="text-xl font-semibold mb-4 tracking-tight">Understanding Buffer Action</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                <div>
                    <h3 class="font-semibold mb-2 text-foreground">How This Buffer Works</h3>
                    <p class="mb-3 text-muted-foreground leading-relaxed">
                        A buffer is a solution that resists changes in pH when small amounts of acid or base are added. The acetic acid/sodium acetate buffer works through the following equilibrium:
                    </p>
                    {/* Code block styling */}
                    <p class="text-center mb-3 font-mono bg-muted/50 border border-border rounded-md p-2 text-xs text-muted-foreground">
                        CH₃COOH(aq) ⇌ CH₃COO⁻(aq) + H⁺(aq)
                    </p>
                    <p class="mb-3 text-muted-foreground leading-relaxed">
                        When HCl is added, it dissociates completely:
                    </p>
                     <p class="text-center mb-3 font-mono bg-muted/50 border border-border rounded-md p-2 text-xs text-muted-foreground">
                        HCl(aq) → H⁺(aq) + Cl⁻(aq)
                    </p>
                    <p class="text-muted-foreground leading-relaxed">
                        The excess H⁺ ions react with acetate ions (CH₃COO⁻) to form acetic acid (CH₃COOH), minimizing the change in pH. This is the buffer action.
                    </p>
                </div>
                <div>
                    <h3 class="font-semibold mb-2 text-foreground">Buffer Capacity Factors</h3>
                    <ul class="list-disc list-inside text-muted-foreground space-y-2 leading-relaxed">
                        <li>Buffer capacity is highest when [CH₃COOH] ≈ [CH₃COO⁻] (ratio ≈ 1:1)</li>
                        <li>Buffer capacity increases with higher total buffer concentration</li>
                        <li>A buffer is most effective when pH is within ±1 unit of the pKa (here, 3.74-5.74)</li>
                        <li>The buffer can be overwhelmed if excessive acid/base is added</li>
                        <li>The Henderson-Hasselbalch equation relates pH, pKa, and component concentrations</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to get color from CSS variable
        function getCssVariable(variable) {
            return getComputedStyle(document.documentElement).getPropertyValue(variable).trim();
        }
         // Function to convert HSL string to rgba for Chart.js
        function hslToRgba(hslString, alpha = 1) {
            // Check if it's already rgba or hex
             if (hslString.startsWith('rgba')) return hslString;
             if (hslString.startsWith('#')) return hslString; // Basic hex support

            try {
                // Simple HSL string parser (e.g., "248 57% 57%")
                 const [h, s, l] = hslString.split(' ').map((val, index) => {
                     return parseFloat(val.replace('%', ''));
                 });
                 
                 const saturation = s / 100;
                 const lightness = l / 100;

                let c = (1 - Math.abs(2 * lightness - 1)) * saturation;
                let x = c * (1 - Math.abs((h / 60) % 2 - 1));
                let m = lightness - c/2;
                let r = 0, g = 0, b = 0;

                if (0 <= h && h < 60) { r = c; g = x; b = 0; }
                else if (60 <= h && h < 120) { r = x; g = c; b = 0; }
                else if (120 <= h && h < 180) { r = 0; g = c; b = x; }
                else if (180 <= h && h < 240) { r = 0; g = x; b = c; }
                else if (240 <= h && h < 300) { r = x; g = 0; b = c; }
                else if (300 <= h && h < 360) { r = c; g = 0; b = x; }

                r = Math.round((r + m) * 255);
                g = Math.round((g + m) * 255);
                b = Math.round((b + m) * 255);

                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            } catch (e) {
                 console.error("Failed to parse HSL:", hslString, e);
                 // Fallback color
                 return `rgba(0, 0, 0, ${alpha})`;
             }
         }

        // Initialize dark mode based on user preference
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        // Watch for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
             if (!('theme' in localStorage)) { // Only respect system change if no theme is explicitly set
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                // Re-init charts on theme change
                 if (concentrationChart) concentrationChart.destroy();
                 if (phCurveChart) phCurveChart.destroy();
                 initCharts();
                 updateUI();
             }
        });

        // DOM elements
        const aceticConcentration = document.getElementById('acetic-concentration');
        const aceticValue = document.getElementById('acetic-value');
        const acetateConcentration = document.getElementById('acetate-concentration');
        const acetateValue = document.getElementById('acetate-value');
        const hclConcentration = document.getElementById('hcl-concentration');
        const hclValue = document.getElementById('hcl-value');
        const kaValue = document.getElementById('ka-value');
        const initialPh = document.getElementById('initial-ph');
        const currentPh = document.getElementById('current-ph');
        const phChange = document.getElementById('ph-change');
        const hhEquationValues = document.getElementById('hh-equation-values');
        const bufferCapacityBar = document.getElementById('buffer-capacity-bar');
        const resetBtn = document.getElementById('reset-btn');
        const visualization = document.getElementById('visualization');

        // Charts
        let concentrationChart = null;
        let phCurveChart = null;

        // Constants
        const KA_ACETIC = 1.8e-5;  // Ka of acetic acid
        const PKA_ACETIC = -Math.log10(KA_ACETIC); // pKa of acetic acid

        // State variables
        let aceticConc = parseFloat(aceticConcentration.value);
        let acetateConc = parseFloat(acetateConcentration.value);
        let hclConc = parseFloat(hclConcentration.value);
        let initialPHValue = 0;
        let phCurveData = [];
        let particles = [];
        let animationFrame; // Store animation frame request

        // Initialize Charts
        function initCharts() {
             const isDarkMode = document.documentElement.classList.contains('dark');

             // Get colors from CSS variables
             const primaryColor = hslToRgba(getCssVariable('--primary'));
             const textColor = hslToRgba(getCssVariable('--foreground'));
             const gridColor = hslToRgba(getCssVariable('--border'), 0.5); // Use border color with alpha for grid
             const mutedColor = hslToRgba(getCssVariable('--muted'));
             const redColor = 'rgba(239, 68, 68, 0.7)'; // Keep explicit red for comparison curve

             // Particle colors (kept same for visual consistency)
             const particleColors = {
                 acetic: 'rgba(245, 158, 11, 0.9)', // yellow-500 adjusted alpha
                 acetate: 'rgba(16, 185, 129, 0.9)', // green-500 adjusted alpha
                 na: 'rgba(168, 85, 247, 0.9)', // purple-500 adjusted alpha
                 h: 'rgba(239, 68, 68, 0.9)', // red-500 adjusted alpha
                 cl: 'rgba(59, 130, 246, 0.9)', // blue-500 adjusted alpha
             };

            // Concentration chart
            const concentrationCanvas = document.getElementById('concentration-chart');
            if (!concentrationCanvas) return;
            const concentrationCtx = concentrationCanvas.getContext('2d');
            if (!concentrationCtx) return;

            concentrationChart = new Chart(concentrationCtx, {
                type: 'bar',
                data: {
                    labels: ['CH₃COOH', 'CH₃COO⁻', 'Na⁺', 'H⁺', 'Cl⁻'],
                    datasets: [{
                        label: 'Concentration (M)',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            particleColors.acetic,
                            particleColors.acetate,
                            particleColors.na,
                            particleColors.h,
                            particleColors.cl,
                        ],
                        // Use border color for bar borders
                        borderColor: Array(5).fill(hslToRgba(getCssVariable('--border'))),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                             backgroundColor: hslToRgba(getCssVariable('--popover')),
                             titleColor: hslToRgba(getCssVariable('--popover-foreground')),
                             bodyColor: hslToRgba(getCssVariable('--popover-foreground')),
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    return value < 0.001 ? `${value.toExponential(3)} M` : `${value.toFixed(4)} M`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Concentration (M)', color: textColor },
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    }
                }
            });

            // pH Curve chart
            const phCurveCanvas = document.getElementById('ph-curve-chart');
            if (!phCurveCanvas) return;
            const phCurveCtx = phCurveCanvas.getContext('2d');
            if (!phCurveCtx) return;

            phCurveChart = new Chart(phCurveCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Buffer Solution',
                        data: [],
                        borderColor: primaryColor,
                        backgroundColor: primaryColor.replace('rgba', 'rgba').replace(')', ', 0.1)'), // Add alpha
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: primaryColor,
                        pointRadius: 0, // Hide points by default
                         pointHoverRadius: 4
                    },
                    {
                        label: 'Water (No Buffer)',
                        data: [],
                        borderColor: redColor,
                        backgroundColor: redColor.replace('0.7', '0.05'), // Lighter fill
                        borderDash: [5, 5],
                        tension: 0.3,
                        fill: true,
                         pointBackgroundColor: redColor,
                         pointRadius: 0,
                         pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: textColor } },
                         tooltip: {
                             backgroundColor: hslToRgba(getCssVariable('--popover')),
                             titleColor: hslToRgba(getCssVariable('--popover-foreground')),
                             bodyColor: hslToRgba(getCssVariable('--popover-foreground')),
                         }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'pH', color: textColor },
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            title: { display: true, text: 'HCl Added (M)', color: textColor },
                            ticks: { color: textColor, maxRotation: 0, minRotation: 0, autoSkip: true, maxTicksLimit: 6 },
                            grid: { color: gridColor }
                        }
                    }
                }
            });
        }

        // Calculate equilibrium concentrations and pH (NO CHANGE NEEDED IN LOGIC)
        function calculateEquilibrium() {
            const initialAcetic = aceticConc;
            const initialAcetate = acetateConc;
            const initialHCl = hclConc;

            const acetateConsumed = Math.min(initialAcetate, initialHCl);
            const hclRemaining = initialHCl - acetateConsumed;

            const finalAcetate = initialAcetate - acetateConsumed;
            const finalAcetic = initialAcetic + acetateConsumed;
            const finalNa = initialAcetate;
            const finalCl = initialHCl;

            let hConcFromHCl = hclRemaining;
            let hConcFromEquilibrium;

            if (finalAcetate > 1e-9) { // Use small threshold instead of 0
                hConcFromEquilibrium = KA_ACETIC * (finalAcetic / finalAcetate);
            } else if (finalAcetic > 1e-9) {
                // Approximation for weak acid dissociation when base is depleted
                 // Ka = [H+]^2 / [HA], assume [H+] = x, [HA] = finalAcetic - x ≈ finalAcetic
                 hConcFromEquilibrium = Math.sqrt(KA_ACETIC * finalAcetic);
                 // If only strong acid remains, this term should be negligible or zero
                 if (hclRemaining > 0 && finalAcetic < 1e-9) hConcFromEquilibrium = 0;
            } else {
                // Only strong acid remaining, or just water
                hConcFromEquilibrium = (hclRemaining > 0) ? 0 : 1e-7; // H+ from water if nothing else
            }

            // Total H+ conc, ensuring it's not less than water autoionization contribution
            const totalHConc = Math.max(hConcFromHCl + hConcFromEquilibrium, 1e-14);
            const pH = -Math.log10(totalHConc);

            const waterHConc = initialHCl > 1e-9 ? initialHCl : 1e-7;
            const waterPH = -Math.log10(waterHConc);

            const ratio = (finalAcetate > 1e-9 && finalAcetic > 1e-9) ? finalAcetate / finalAcetic : 0;
            const logRatioTerm = (ratio > 0) ? Math.abs(Math.log10(ratio)) : 10; // Penalize heavily if ratio is zero or invalid
            const bufferCapacityRatio = 1 - Math.min(logRatioTerm / 2, 1); // Normalize between 0 and 1, max penalty at 100:1 or 1:100 ratio

            const totalBufferConcentration = finalAcetic + finalAcetate;
            const normalizedConcentration = Math.min(totalBufferConcentration / 0.5, 1); // Max capacity boost at 0.5M total

            const bufferCapacityScore = bufferCapacityRatio * normalizedConcentration;


             // Ensure calculated concentrations aren't negative due to floating point issues
             const safeFinalAcetic = Math.max(0, finalAcetic);
             const safeFinalAcetate = Math.max(0, finalAcetate);

            return {
                aceticConc: safeFinalAcetic,
                acetateConc: safeFinalAcetate,
                naConc: finalNa,
                hConc: totalHConc,
                clConc: finalCl,
                pH: pH,
                waterPH: waterPH,
                bufferCapacityScore: bufferCapacityScore,
                ratio: ratio // Use original ratio for HH display
            };
        }

        // Update pH curve data (NO CHANGE NEEDED IN LOGIC)
        function updatePHCurveData() {
            const currentAcetic = aceticConc;
            const currentAcetate = acetateConc;
            const currentHclSliderValue = parseFloat(hclConcentration.value); // Store slider value

            const hclPoints = [];
            const bufferPHPoints = [];
            const waterPHPoints = [];

            const numPoints = 41; // Increased points for smoother curve
            const maxHCl = parseFloat(hclConcentration.max); // Use slider max

            for (let i = 0; i < numPoints; i++) {
                const pointHCl = (i / (numPoints - 1)) * maxHCl;
                hclPoints.push(pointHCl.toFixed(3));

                // Temporarily set hclConc for calculation
                hclConc = pointHCl;
                const result = calculateEquilibrium();
                bufferPHPoints.push(result.pH);
                waterPHPoints.push(result.waterPH);
            }

            // Restore actual state
            hclConc = currentHclSliderValue;
            aceticConc = currentAcetic;
            acetateConc = currentAcetate;

            return { labels: hclPoints, bufferPHPoints, waterPHPoints };
        }

        // Update UI
        function updateUI() {
            const result = calculateEquilibrium();

            if (hclConc === 0) {
                initialPHValue = result.pH;
                initialPh.textContent = result.pH.toFixed(2);
            }

            currentPh.textContent = result.pH.toFixed(2);
            const pHChangeValue = result.pH - initialPHValue;
            phChange.textContent = pHChangeValue.toFixed(2);

            // Update HH equation display
            if (result.acetateConc > 1e-9 && result.aceticConc > 1e-9) {
                 const displayAcetate = result.acetateConc.toFixed(3);
                 const displayAcetic = result.aceticConc.toFixed(3);
                 hhEquationValues.textContent = `${result.pH.toFixed(2)} = ${PKA_ACETIC.toFixed(2)} + log(${displayAcetate}/${displayAcetic})`;
             } else if (result.acetateConc <= 1e-9 && result.aceticConc > 1e-9) {
                 hhEquationValues.textContent = "pH dominated by remaining acid";
             } else if (result.hclConc > result.acetateConc && result.acetateConc > 1e-9) {
                 hhEquationValues.textContent = "pH dominated by excess HCl";
             } else {
                 hhEquationValues.textContent = "Buffer exhausted or undefined ratio";
             }

            bufferCapacityBar.style.width = `${Math.max(0, Math.min(100, result.bufferCapacityScore * 100))}%`;


            // Update charts only if they exist
             if (concentrationChart && concentrationChart.data) {
                 concentrationChart.data.datasets[0].data = [
                     result.aceticConc,
                     result.acetateConc,
                     result.naConc,
                     result.hConc,
                     result.clConc
                 ];
                  // Update colors based on current theme potentially? No, keep particle colors fixed.
                 concentrationChart.update('none'); // Use 'none' to prevent animation flicker on slider drag
             }

             if (phCurveChart && phCurveChart.data) {
                 const curveData = updatePHCurveData();
                 phCurveChart.data.labels = curveData.labels;
                 phCurveChart.data.datasets[0].data = curveData.bufferPHPoints;
                 phCurveChart.data.datasets[1].data = curveData.waterPHPoints;
                 // Update colors based on theme
                 const primaryColor = hslToRgba(getCssVariable('--primary'));
                 phCurveChart.data.datasets[0].borderColor = primaryColor;
                 phCurveChart.data.datasets[0].backgroundColor = primaryColor.replace('rgba', 'rgba').replace(')', ', 0.1)');
                 phCurveChart.data.datasets[0].pointBackgroundColor = primaryColor;
                 phCurveChart.options.scales.y.ticks.color = hslToRgba(getCssVariable('--foreground'));
                 phCurveChart.options.scales.x.ticks.color = hslToRgba(getCssVariable('--foreground'));
                 phCurveChart.options.scales.y.grid.color = hslToRgba(getCssVariable('--border'), 0.5);
                 phCurveChart.options.scales.x.grid.color = hslToRgba(getCssVariable('--border'), 0.5);
                 phCurveChart.options.plugins.legend.labels.color = hslToRgba(getCssVariable('--foreground'));

                 phCurveChart.update('none'); // Use 'none' to prevent animation flicker
             }

            updateVisualization(result); // Update particles
            return result;
        }

        // Visualization (NO CHANGE NEEDED IN LOGIC, but adjusted createParticle)
        function updateVisualization(result) {
            visualization.innerHTML = '';
            particles = [];
            if (animationFrame) {
                cancelAnimationFrame(animationFrame); // Stop previous animation
            }

            const maxParticles = 250; // Slightly more particles
            const totalConc = result.aceticConc + result.acetateConc + result.naConc + result.hConc + result.clConc;

            // Avoid division by zero if total concentration is near zero
            if (totalConc < 1e-9) {
                animateParticles(); // Start animation loop even if empty
                return;
            }

             // Calculate particle counts, ensuring minimum 1 if concentration > 0
             let numAcetic = result.aceticConc > 1e-9 ? Math.max(1, Math.round((result.aceticConc / totalConc) * maxParticles)) : 0;
             let numAcetate = result.acetateConc > 1e-9 ? Math.max(1, Math.round((result.acetateConc / totalConc) * maxParticles)) : 0;
             let numNa = result.naConc > 1e-9 ? Math.max(1, Math.round((result.naConc / totalConc) * maxParticles)) : 0;
             let numH = result.hConc > 1e-9 ? Math.max(1, Math.round((result.hConc / totalConc) * maxParticles)) : 0;
             let numCl = result.clConc > 1e-9 ? Math.max(1, Math.round((result.clConc / totalConc) * maxParticles)) : 0;

             // Particle colors mapping (using fixed colors for clarity)
             const colors = {
                 acetic: 'bg-yellow-500', acetate: 'bg-green-500', na: 'bg-purple-500', h: 'bg-red-500', cl: 'bg-blue-500'
             };

             // Create particles
             for (let i = 0; i < numAcetic; i++) createParticle('acetic', colors.acetic);
             for (let i = 0; i < numAcetate; i++) createParticle('acetate', colors.acetate);
             for (let i = 0; i < numNa; i++) createParticle('na', colors.na);
             for (let i = 0; i < numH; i++) createParticle('h', colors.h);
             for (let i = 0; i < numCl; i++) createParticle('cl', colors.cl);

            animateParticles();
        }

        function createParticle(type, colorClass) {
            const particle = document.createElement('div');
            let size = '6px'; // Default size
            if (type === 'acetic') size = '10px';
            else if (type === 'acetate') size = '9px';
            else if (type === 'na' || type === 'cl') size = '7px';
            else if (type === 'h') size = '4px';

             // Use Tailwind classes for styling
            particle.className = `absolute rounded-full ${colorClass} shadow-sm`;
            particle.style.width = size;
            particle.style.height = size;
            particle.style.willChange = 'transform'; // Optimize for animation

            const visRect = visualization.getBoundingClientRect();
             // Ensure width/height are available, provide fallback
             const visWidth = visRect.width || 300;
             const visHeight = visRect.height || 256;

             // Calculate max position ensuring particle stays within bounds based on its size
             const pSize = parseFloat(size);
             const maxX = visWidth - pSize;
             const maxY = visHeight - pSize;

             // Initial position in pixels, constrained within bounds
             const x = Math.random() * maxX;
             const y = Math.random() * maxY;

            particle.style.transform = `translate(${x}px, ${y}px)`; // Use transform for better performance

            visualization.appendChild(particle);

            particles.push({
                element: particle,
                x: x, y: y,
                // Slower speeds
                vx: (Math.random() - 0.5) * 0.4,
                vy: (Math.random() - 0.5) * 0.4,
                size: pSize, // Store size in pixels
                type: type
            });
        }


        function animateParticles() {
            const visRect = visualization.getBoundingClientRect();
            const visWidth = visRect.width || 300;
            const visHeight = visRect.height || 256;

            function updatePositions() {
                particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;

                    // Bounce off walls, considering particle size
                    if (p.x <= 0) { p.x = 0; p.vx *= -1; }
                    if (p.x >= visWidth - p.size) { p.x = visWidth - p.size; p.vx *= -1; }
                    if (p.y <= 0) { p.y = 0; p.vy *= -1; }
                    if (p.y >= visHeight - p.size) { p.y = visHeight - p.size; p.vy *= -1; }

                    // Apply position using transform
                    p.element.style.transform = `translate(${p.x}px, ${p.y}px)`;
                });

                animationFrame = requestAnimationFrame(updatePositions);
            }

            // Cancel existing animation frame before starting a new one
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
            animationFrame = requestAnimationFrame(updatePositions);
        }

        // Initialize Simulation
        function initSimulation() {
            initCharts();
            aceticConc = parseFloat(aceticConcentration.value);
            acetateConc = parseFloat(acetateConcentration.value);
            hclConc = parseFloat(hclConcentration.value);
            aceticValue.textContent = aceticConc.toFixed(3);
            acetateValue.textContent = acetateConc.toFixed(3);
            hclValue.textContent = hclConc.toFixed(3);
            kaValue.textContent = KA_ACETIC.toExponential(1).replace('e-', ' × 10⁻');
            const result = updateUI(); // Initial calculation and UI update
            initialPHValue = result.pH; // Set initial pH based on initial state
            initialPh.textContent = initialPHValue.toFixed(2); // Ensure initial pH displays correctly
        }

        // Event Listeners
        aceticConcentration.addEventListener('input', () => {
            aceticConc = parseFloat(aceticConcentration.value);
            aceticValue.textContent = aceticConc.toFixed(3);
            updateUI();
        });

        acetateConcentration.addEventListener('input', () => {
            acetateConc = parseFloat(acetateConcentration.value);
            acetateValue.textContent = acetateConc.toFixed(3);
            updateUI();
        });

        hclConcentration.addEventListener('input', () => {
            hclConc = parseFloat(hclConcentration.value);
            hclValue.textContent = hclConc.toFixed(3);
            updateUI();
        });

        resetBtn.addEventListener('click', () => {
             aceticConcentration.value = 0.1;
             acetateConcentration.value = 0.1;
             hclConcentration.value = 0;

             // Trigger input events to update state and UI correctly
             aceticConcentration.dispatchEvent(new Event('input', { bubbles:true }));
             acetateConcentration.dispatchEvent(new Event('input', { bubbles:true }));
             hclConcentration.dispatchEvent(new Event('input', { bubbles:true }));

             // Recalculate and ensure initial pH is reset correctly
             const result = calculateEquilibrium(); // Perform calculation with reset values
             initialPHValue = result.pH; // Set the baseline pH again
             updateUI(); // Update the entire UI
             initialPh.textContent = initialPHValue.toFixed(2); // Explicitly set initial pH display
             currentPh.textContent = initialPHValue.toFixed(2);
             phChange.textContent = "0.00";
        });

         // Re-initialize charts on window resize potentially (optional)
         let resizeTimer;
         window.addEventListener('resize', () => {
             clearTimeout(resizeTimer);
             resizeTimer = setTimeout(() => {
                 // Could re-init charts here if needed, but Chart.js responsive should handle most cases
                 // updateUI(); // Redraw visualization if needed after resize
             }, 250);
         });

        // Initialize after DOM is ready
        document.addEventListener('DOMContentLoaded', initSimulation);

    </script>
</body>
</html>